/*
 * Copyright 2019 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.gradle.api.java.archives.internal

import org.gradle.util.TextUtil

import spock.lang.Specification

import java.nio.charset.StandardCharsets

class ManifestWriterTest extends Specification {
    // The values here are printed with ManifestWriter#entry
    StringWriter sw = new StringWriter()
    ManifestWriter mw = new ManifestWriter(sw)
    // The values here are printed with ManifestWriter#write(char[],...)
    StringWriter sw2 = new StringWriter()
    ManifestWriter mw2 = new ManifestWriter(sw2)
    // The values here are printed with ManifestWriter#write(char)
    StringWriter sw3 = new StringWriter()
    ManifestWriter mw3 = new ManifestWriter(sw3)

    String expected
    String printAsEntry
    String printAsCharArray
    String printAsChars

    private int longestLine(String s) {
        s.lines()
            .mapToInt { it.getBytes(StandardCharsets.UTF_8).length }
            .max()
            .getAsInt()
    }

    private def writeEntryAsCharArray(String name, String value) {
        def chars = (name + ": " + value).toCharArray()
        mw2.write(chars)
        mw2.newLine()
        for (char c : chars) {
            mw3.write(c)
        }
        mw3.newLine()
    }

    private def print(String value) {
        // The intention here is that each value will be "cut" at different byte position
        // Thus multi-byte characters will be examined at different splits
        mw.entry("1", value)
        mw.entry("22", value)
        mw.entry("333", value)
        mw.entry("4444", value)
        mw.entry("55555", value)
        mw.entry("666666", value)
        mw.flush()
        printAsEntry = sw.toString()
        writeEntryAsCharArray("1", value)
        writeEntryAsCharArray("22", value)
        writeEntryAsCharArray("333", value)
        writeEntryAsCharArray("4444", value)
        writeEntryAsCharArray("55555", value)
        writeEntryAsCharArray("666666", value)
        mw2.flush()
        printAsCharArray = sw2.toString()
        mw3.flush()
        printAsChars = sw3.toString()
    }

    def "German: Ã¤, 1 char, 1 codepoint, 2 bytes"() {
        when:
        print("Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤")
        expected =
            TextUtil.convertLineSeparators(
                '''|1: Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤
                   | Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤
                   | Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤
                   |22: Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤
                   | Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤
                   | Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤
                   |333: Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤
                   | Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤
                   | Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤
                   |4444: Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤
                   | Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤
                   | Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤
                   |55555: Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤
                   | Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤
                   | Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤
                   |666666: Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤
                   | Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤
                   | Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤Ã¤
                   |'''.stripMargin(), "\r\n")

        then:
        longestLine(printAsEntry) == 72

        and:
        printAsEntry == expected
        printAsCharArray == expected
        printAsChars == expected
    }

    def "Cyrillic: Ð¹, 1 char, 1 codepoint, 2 bytes"() {
        when:
        print("Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹")
        expected =
            TextUtil.convertLineSeparators(
                '''|1: Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹
                   | Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹
                   | Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹
                   |22: Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹
                   | Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹
                   | Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹
                   |333: Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹
                   | Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹
                   | Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹
                   |4444: Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹
                   | Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹
                   | Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹
                   |55555: Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹
                   | Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹
                   | Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹
                   |666666: Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹
                   | Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹
                   | Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹Ð¹
                   |'''.stripMargin(), "\r\n")

        then:
        longestLine(printAsEntry) == 72

        and:
        printAsEntry == expected
        printAsCharArray == expected
        printAsChars == expected
    }

    def "Kanji: ä¸ˆ, 1 char, 1 codepoint, 3 bytes"() {
        when:
        print("ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ")
        expected =
            TextUtil.convertLineSeparators(
                '''|1: ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ
                   | ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ
                   | ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ
                   |22: ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ
                   | ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ
                   | ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ
                   |333: ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ
                   | ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ
                   | ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ
                   |4444: ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ
                   | ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ
                   | ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ
                   |55555: ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ
                   | ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ
                   | ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ
                   |666666: ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ
                   | ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ
                   | ä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆä¸ˆ
                   |'''.stripMargin(), "\r\n")

        then:
        longestLine(printAsEntry) == 72

        and:
        printAsEntry == expected
        printAsCharArray == expected
        printAsChars == expected
    }

    def "Emoji: ðŸ˜ƒ, 2 chars, 1 codepoint, 4 bytes"() {
        when:
        print("ðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒ")
        expected =
            TextUtil.convertLineSeparators(
                '''|1: ðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒ
                   | ðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒ
                   |22: ðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒ
                   | ðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒ
                   |333: ðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒ
                   | ðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒ
                   |4444: ðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒ
                   | ðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒ
                   |55555: ðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒ
                   | ðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒ
                   |666666: ðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒ
                   | ðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒðŸ˜ƒ
                   |'''.stripMargin(), "\r\n")

        then:
        longestLine(printAsEntry) == 72

        and:
        printAsEntry == expected
        printAsCharArray == expected
        printAsChars == expected
    }

    def "Grapheme cluster: à¤¨ + à¤¿ == à¤¨à¤¿, 2 chars, 2 codepoints, 6 bytes"() {
        when:
        print("à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿")
        expected =
            TextUtil.convertLineSeparators(
                '''|1: à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨
                   | à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿
                   | à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿
                   |22: à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿
                   | à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨
                   | à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿
                   |333: à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿
                   | à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨
                   | à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿
                   |4444: à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿
                   | à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨
                   | à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿
                   |55555: à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨
                   | à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿
                   | à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿
                   |666666: à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨
                   | à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿
                   | à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿à¤¨à¤¿
                   |'''.stripMargin(), "\r\n")

        then:
        longestLine(printAsEntry) == 72

        and:
        // Splitting the grapheme to multiple lines is OK, as each bit is still a valid UTF-8 sequence
        printAsEntry == expected
        printAsCharArray == expected
        printAsChars == expected
    }
}

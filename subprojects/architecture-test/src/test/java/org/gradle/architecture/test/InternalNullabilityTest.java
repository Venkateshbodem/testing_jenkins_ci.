/*
 * Copyright 2022 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.gradle.architecture.test;

import com.tngtech.archunit.base.DescribedPredicate;
import com.tngtech.archunit.core.domain.JavaClass;
import com.tngtech.archunit.junit.AnalyzeClasses;
import com.tngtech.archunit.junit.ArchTest;
import com.tngtech.archunit.lang.ArchRule;
import org.gradle.api.NonNullApi;

import java.util.Arrays;
import java.util.HashSet;
import java.util.Set;

import static com.tngtech.archunit.base.DescribedPredicate.not;
import static com.tngtech.archunit.lang.syntax.ArchRuleDefinition.classes;
import static org.gradle.architecture.test.ArchUnitFixture.beAnnotatedOrInPackageAnnotatedWith;
import static org.gradle.architecture.test.ArchUnitFixture.classes_not_written_in_kotlin;
import static org.gradle.architecture.test.ArchUnitFixture.gradleInternalApi;

@AnalyzeClasses(packages = "org.gradle")
public class InternalNullabilityTest {

    /**
     * List of packages that are not yet annotated with {@link NonNullApi}.
     * This list should never grow and should be empty at some point.
     */
    private static final Set<String> PENDING_ANNOTATION = new HashSet<>(Arrays.asList(
        "org.gradle.api.distribution.internal",
        "org.gradle.api.internal.artifacts.component",
        "org.gradle.api.internal.artifacts.configurations.dynamicversion",
        "org.gradle.api.internal.artifacts.ivyservice.clientmodule",
        "org.gradle.api.internal.artifacts.ivyservice.ivyresolve.parser",
        "org.gradle.api.internal.artifacts.ivyservice.ivyresolve.parser.data",
        "org.gradle.api.internal.artifacts.ivyservice.ivyresolve.strategy",
        "org.gradle.api.internal.artifacts.ivyservice.ivyresolve.verification.utils",
        "org.gradle.api.internal.artifacts.ivyservice.modulecache",
        "org.gradle.api.internal.artifacts.ivyservice.modulecache.artifacts",
        "org.gradle.api.internal.artifacts.ivyservice.modulecache.dynamicversions",
        "org.gradle.api.internal.artifacts.ivyservice.moduleconverter",
        "org.gradle.api.internal.artifacts.ivyservice.projectmodule",
        "org.gradle.api.internal.artifacts.ivyservice.resolveengine.excludes",
        "org.gradle.api.internal.artifacts.ivyservice.resolveengine.excludes.factories",
        "org.gradle.api.internal.artifacts.ivyservice.resolveengine.excludes.simple",
        "org.gradle.api.internal.artifacts.ivyservice.resolveengine.excludes.specs",
        "org.gradle.api.internal.artifacts.ivyservice.resolveengine.graph.selectors",
        "org.gradle.api.internal.artifacts.ivyservice.resolveengine.projectresult",
        "org.gradle.api.internal.artifacts.ivyservice.resolveengine.strict",
        "org.gradle.api.internal.artifacts.metadata",
        "org.gradle.api.internal.artifacts.mvnsettings",
        "org.gradle.api.internal.artifacts.publish",
        "org.gradle.api.internal.artifacts.repositories.descriptor",
        "org.gradle.api.internal.artifacts.repositories.layout",
        "org.gradle.api.internal.artifacts.repositories.maven",
        "org.gradle.api.internal.artifacts.repositories.transport",
        "org.gradle.api.internal.artifacts.type",
        "org.gradle.api.internal.artifacts.verification.exceptions",
        "org.gradle.api.internal.artifacts.verification.model",
        "org.gradle.api.internal.artifacts.verification.serializer",
        "org.gradle.api.internal.artifacts.verification.signatures",
        "org.gradle.api.internal.artifacts.verification.verifier",
        "org.gradle.api.internal.cache",
        "org.gradle.api.internal.capabilities",
        "org.gradle.api.internal.catalog.parser",
        "org.gradle.api.internal.catalog.problems",
        "org.gradle.api.internal.changedetection",
        "org.gradle.api.internal.classloading",
        "org.gradle.api.internal.classpath",
        "org.gradle.api.internal.coerce",
        "org.gradle.api.internal.collections",
        "org.gradle.api.internal.component",
        "org.gradle.api.internal.composite",
        "org.gradle.api.internal.credentials",
        "org.gradle.api.internal.exceptions",
        "org.gradle.api.internal.file.ant",
        "org.gradle.api.internal.file.archive.compression",
        "org.gradle.api.internal.file.archive.impl",
        "org.gradle.api.internal.file.delete",
        "org.gradle.api.internal.file.pattern",
        "org.gradle.api.internal.file.temp",
        "org.gradle.api.internal.filestore",
        "org.gradle.api.internal.java",
        "org.gradle.api.internal.java.usagecontext",
        "org.gradle.api.internal.jvm",
        "org.gradle.api.internal.lambdas",
        "org.gradle.api.internal.notations",
        "org.gradle.api.internal.plugins",
        "org.gradle.api.internal.project.ant",
        "org.gradle.api.internal.project.antbuilder",
        "org.gradle.api.internal.properties",
        "org.gradle.api.internal.provider.sources",
        "org.gradle.api.internal.provider.sources.process",
        "org.gradle.api.internal.provider.support",
        "org.gradle.api.internal.resolve",
        "org.gradle.api.internal.rules",
        "org.gradle.api.internal.runtimeshaded",
        "org.gradle.api.internal.specs",
        "org.gradle.api.internal.tasks.compile.daemon",
        "org.gradle.api.internal.tasks.compile.filter",
        "org.gradle.api.internal.tasks.compile.incremental",
        "org.gradle.api.internal.tasks.compile.incremental.analyzer",
        "org.gradle.api.internal.tasks.compile.incremental.asm",
        "org.gradle.api.internal.tasks.compile.incremental.cache",
        "org.gradle.api.internal.tasks.compile.incremental.classpath",
        "org.gradle.api.internal.tasks.compile.incremental.compilerapi",
        "org.gradle.api.internal.tasks.compile.incremental.compilerapi.constants",
        "org.gradle.api.internal.tasks.compile.incremental.compilerapi.deps",
        "org.gradle.api.internal.tasks.compile.incremental.deps",
        "org.gradle.api.internal.tasks.compile.incremental.processing",
        "org.gradle.api.internal.tasks.compile.incremental.recomp",
        "org.gradle.api.internal.tasks.compile.incremental.serialization",
        "org.gradle.api.internal.tasks.compile.incremental.transaction",
        "org.gradle.api.internal.tasks.compile.processing",
        "org.gradle.api.internal.tasks.compile.reflect",
        "org.gradle.api.internal.tasks.compile.tooling",
        "org.gradle.api.internal.tasks.execution.statistics",
        "org.gradle.api.internal.tasks.options",
        "org.gradle.api.internal.tasks.scala",
        "org.gradle.api.internal.tasks.testing",
        "org.gradle.api.internal.tasks.testing.detection",
        "org.gradle.api.internal.tasks.testing.filter",
        "org.gradle.api.internal.tasks.testing.junit",
        "org.gradle.api.internal.tasks.testing.junit.result",
        "org.gradle.api.internal.tasks.testing.junitplatform",
        "org.gradle.api.internal.tasks.testing.logging",
        "org.gradle.api.internal.tasks.testing.operations",
        "org.gradle.api.internal.tasks.testing.processors",
        "org.gradle.api.internal.tasks.testing.report",
        "org.gradle.api.internal.tasks.testing.results",
        "org.gradle.api.internal.tasks.testing.testng",
        "org.gradle.api.internal.tasks.testing.worker",
        "org.gradle.api.internal.tasks.userinput",
        "org.gradle.api.java.archives.internal",
        "org.gradle.api.plugins.antlr",
        "org.gradle.api.plugins.antlr.internal",
        "org.gradle.api.plugins.antlr.internal.antlr2",
        "org.gradle.api.plugins.internal",
        "org.gradle.api.plugins.scala",
        "org.gradle.api.publish.internal",
        "org.gradle.api.publish.internal.metadata",
        "org.gradle.api.publish.internal.service",
        "org.gradle.api.publish.internal.validation",
        "org.gradle.api.publish.internal.versionmapping",
        "org.gradle.api.publish.ivy.internal",
        "org.gradle.api.publish.ivy.internal.artifact",
        "org.gradle.api.publish.ivy.internal.dependency",
        "org.gradle.api.publish.ivy.internal.publication",
        "org.gradle.api.publish.ivy.internal.publisher",
        "org.gradle.api.publish.ivy.internal.versionmapping",
        "org.gradle.api.publish.ivy.plugins",
        "org.gradle.api.publish.ivy.tasks",
        "org.gradle.api.publish.maven.internal",
        "org.gradle.api.publish.maven.internal.artifact",
        "org.gradle.api.publish.maven.internal.dependencies",
        "org.gradle.api.publish.maven.internal.publication",
        "org.gradle.api.publish.maven.internal.publisher",
        "org.gradle.api.publish.maven.internal.tasks",
        "org.gradle.api.publish.maven.internal.validation",
        "org.gradle.api.publish.maven.plugins",
        "org.gradle.api.publish.maven.tasks",
        "org.gradle.api.publish.plugins",
        "org.gradle.api.publish.tasks",
        "org.gradle.api.reflect",
        "org.gradle.api.reporting.components.internal",
        "org.gradle.api.reporting.model.internal",
        "org.gradle.api.reporting.plugins",
        "org.gradle.api.resources.internal",
        "org.gradle.api.specs",
        "org.gradle.api.specs.internal",
        "org.gradle.api.tasks.bundling.internal",
        "org.gradle.api.tasks.diagnostics.internal.dependencies",
        "org.gradle.api.tasks.diagnostics.internal.dsl",
        "org.gradle.api.tasks.diagnostics.internal.graph",
        "org.gradle.api.tasks.diagnostics.internal.insight",
        "org.gradle.api.tasks.diagnostics.internal.text",
        "org.gradle.api.tasks.internal",
        "org.gradle.api.tasks.scala.internal",
        "org.gradle.api.tasks.testing",
        "org.gradle.api.tasks.testing.testng",
        "org.gradle.api.tasks.util.internal",
        "org.gradle.api.tasks.wrapper",
        "org.gradle.architecture.library.freeze",
        "org.gradle.architecture.test",
        "org.gradle.buildinit.plugins",
        "org.gradle.buildinit.plugins.internal",
        "org.gradle.buildinit.plugins.internal.action",
        "org.gradle.buildinit.plugins.internal.maven",
        "org.gradle.buildinit.plugins.internal.model",
        "org.gradle.buildinit.plugins.internal.modifiers",
        "org.gradle.buildinit.plugins.internal.services",
        "org.gradle.cache.internal.btree",
        "org.gradle.cache.internal.cacheops",
        "org.gradle.cache.internal.filelock",
        "org.gradle.cache.internal.locklistener",
        "org.gradle.cache.internal.scopes",
        "org.gradle.cache.internal.streams",
        "org.gradle.cache.scopes",
        "org.gradle.cli",
        "org.gradle.composite.internal",
        "org.gradle.composite.internal.plugins",
        "org.gradle.configuration",
        "org.gradle.configuration.project",
        "org.gradle.configurationcache",
        "org.gradle.configurationcache.cacheentry",
        "org.gradle.configurationcache.extensions",
        "org.gradle.configurationcache.fingerprint",
        "org.gradle.configurationcache.flow",
        "org.gradle.configurationcache.initialization",
        "org.gradle.configurationcache.metadata",
        "org.gradle.configurationcache.models",
        "org.gradle.configurationcache.problems",
        "org.gradle.configurationcache.serialization",
        "org.gradle.configurationcache.serialization.beans",
        "org.gradle.configurationcache.serialization.codecs",
        "org.gradle.configurationcache.serialization.codecs.jos",
        "org.gradle.configurationcache.serialization.codecs.transform",
        "org.gradle.configurationcache.services",
        "org.gradle.execution.commandline",
        "org.gradle.execution.plan.edges",
        "org.gradle.execution.selection",
        "org.gradle.execution.taskgraph",
        "org.gradle.execution.taskpath",
        "org.gradle.external.javadoc.internal",
        "org.gradle.groovy.scripts",
        "org.gradle.groovy.scripts.internal",
        "org.gradle.ide.visualstudio.internal",
        "org.gradle.ide.visualstudio.plugins",
        "org.gradle.ide.visualstudio.tasks",
        "org.gradle.ide.visualstudio.tasks.internal",
        "org.gradle.ide.xcode.internal",
        "org.gradle.ide.xcode.internal.services",
        "org.gradle.ide.xcode.internal.xcodeproj",
        "org.gradle.ide.xcode.plugins",
        "org.gradle.ide.xcode.tasks",
        "org.gradle.ide.xcode.tasks.internal",
        "org.gradle.initialization.definition",
        "org.gradle.initialization.exception",
        "org.gradle.initialization.layout",
        "org.gradle.initialization.properties",
        "org.gradle.integtests.fixtures",
        "org.gradle.internal.accesscontrol",
        "org.gradle.internal.action",
        "org.gradle.internal.actor",
        "org.gradle.internal.actor.internal",
        "org.gradle.internal.agents",
        "org.gradle.internal.artifacts.repositories",
        "org.gradle.internal.authentication",
        "org.gradle.internal.build",
        "org.gradle.internal.build.event",
        "org.gradle.internal.build.event.types",
        "org.gradle.internal.buildevents",
        "org.gradle.internal.buildoption",
        "org.gradle.internal.buildtree",
        "org.gradle.internal.cache",
        "org.gradle.internal.classanalysis",
        "org.gradle.internal.classpath",
        "org.gradle.internal.classpath.declarations",
        "org.gradle.internal.classpath.intercept",
        "org.gradle.internal.collect",
        "org.gradle.internal.collections",
        "org.gradle.internal.compiler.java",
        "org.gradle.internal.compiler.java.listeners.classnames",
        "org.gradle.internal.compiler.java.listeners.constants",
        "org.gradle.internal.component.external.descriptor",
        "org.gradle.internal.composite",
        "org.gradle.internal.concurrent",
        "org.gradle.internal.configurationcache",
        "org.gradle.internal.configurationcache.options",
        "org.gradle.internal.credentials",
        "org.gradle.internal.deployment",
        "org.gradle.internal.dispatch",
        "org.gradle.internal.enterprise",
        "org.gradle.internal.enterprise.core",
        "org.gradle.internal.enterprise.impl",
        "org.gradle.internal.enterprise.impl.legacy",
        "org.gradle.internal.environment",
        "org.gradle.internal.event",
        "org.gradle.internal.exceptions",
        "org.gradle.internal.execution.timeout",
        "org.gradle.internal.execution.timeout.impl",
        "org.gradle.internal.featurelifecycle",
        "org.gradle.internal.file.excludes",
        "org.gradle.internal.graph",
        "org.gradle.internal.html",
        "org.gradle.internal.installation",
        "org.gradle.internal.installation.beacon",
        "org.gradle.internal.instantiation.generator",
        "org.gradle.internal.instrumentation.api.annotations",
        "org.gradle.internal.instrumentation.api.annotations.features.withstaticreference",
        "org.gradle.internal.instrumentation.api.jvmbytecode",
        "org.gradle.internal.invocation",
        "org.gradle.internal.isolated",
        "org.gradle.internal.jacoco",
        "org.gradle.internal.jacoco.rules",
        "org.gradle.internal.jvm",
        "org.gradle.internal.jvm.inspection",
        "org.gradle.internal.lazy",
        "org.gradle.internal.logging",
        "org.gradle.internal.logging.config",
        "org.gradle.internal.logging.console",
        "org.gradle.internal.logging.events",
        "org.gradle.internal.logging.events.operations",
        "org.gradle.internal.logging.format",
        "org.gradle.internal.logging.progress",
        "org.gradle.internal.logging.serializer",
        "org.gradle.internal.logging.services",
        "org.gradle.internal.logging.sink",
        "org.gradle.internal.logging.slf4j",
        "org.gradle.internal.logging.source",
        "org.gradle.internal.logging.text",
        "org.gradle.internal.logging.util",
        "org.gradle.internal.management",
        "org.gradle.internal.metaobject",
        "org.gradle.internal.model",
        "org.gradle.internal.nativeintegration",
        "org.gradle.internal.nativeintegration.console",
        "org.gradle.internal.nativeintegration.filesystem",
        "org.gradle.internal.nativeintegration.filesystem.jdk7",
        "org.gradle.internal.nativeintegration.filesystem.services",
        "org.gradle.internal.nativeintegration.jansi",
        "org.gradle.internal.nativeintegration.jna",
        "org.gradle.internal.nativeintegration.processenvironment",
        "org.gradle.internal.nativeintegration.services",
        "org.gradle.internal.operations.logging",
        "org.gradle.internal.operations.trace",
        "org.gradle.internal.os",
        "org.gradle.internal.problems",
        "org.gradle.internal.process",
        "org.gradle.internal.progress",
        "org.gradle.internal.reflect.problems",
        "org.gradle.internal.reflect.validation",
        "org.gradle.internal.remote",
        "org.gradle.internal.remote.internal",
        "org.gradle.internal.remote.internal.hub",
        "org.gradle.internal.remote.internal.hub.protocol",
        "org.gradle.internal.remote.internal.hub.queue",
        "org.gradle.internal.remote.services",
        "org.gradle.internal.resolve",
        "org.gradle.internal.resolve.caching",
        "org.gradle.internal.resolve.resolver",
        "org.gradle.internal.resolve.result",
        "org.gradle.internal.resource",
        "org.gradle.internal.resource.cached",
        "org.gradle.internal.resource.connector",
        "org.gradle.internal.resource.local",
        "org.gradle.internal.resource.local.ivy",
        "org.gradle.internal.resource.metadata",
        "org.gradle.internal.resource.transport",
        "org.gradle.internal.resource.transport.aws.s3",
        "org.gradle.internal.resource.transport.file",
        "org.gradle.internal.resource.transport.gcp.gcs",
        "org.gradle.internal.resource.transport.http",
        "org.gradle.internal.resource.transport.http.ntlm",
        "org.gradle.internal.resource.transport.sftp",
        "org.gradle.internal.resources",
        "org.gradle.internal.rules",
        "org.gradle.internal.scan",
        "org.gradle.internal.scan.config",
        "org.gradle.internal.scan.eob",
        "org.gradle.internal.scan.scopeids",
        "org.gradle.internal.scan.time",
        "org.gradle.internal.scopeids",
        "org.gradle.internal.scopeids.id",
        "org.gradle.internal.serialization",
        "org.gradle.internal.serialize",
        "org.gradle.internal.serialize.kryo",
        "org.gradle.internal.service",
        "org.gradle.internal.session",
        "org.gradle.internal.state",
        "org.gradle.internal.time",
        "org.gradle.internal.typeconversion",
        "org.gradle.internal.util",
        "org.gradle.internal.verifier",
        "org.gradle.internal.watch.options",
        "org.gradle.internal.work",
        "org.gradle.internal.xml",
        "org.gradle.invocation",
        "org.gradle.jvm",
        "org.gradle.jvm.component.internal",
        "org.gradle.jvm.internal.services",
        "org.gradle.jvm.tasks",
        "org.gradle.jvm.toolchain.internal.task",
        "org.gradle.language.assembler.internal",
        "org.gradle.language.assembler.plugins",
        "org.gradle.language.assembler.plugins.internal",
        "org.gradle.language.assembler.tasks",
        "org.gradle.language.base.internal",
        "org.gradle.language.base.internal.compile",
        "org.gradle.language.base.internal.plugins",
        "org.gradle.language.base.internal.registry",
        "org.gradle.language.base.internal.resolve",
        "org.gradle.language.base.internal.tasks",
        "org.gradle.language.base.plugins",
        "org.gradle.language.base.sources",
        "org.gradle.language.c.internal",
        "org.gradle.language.c.plugins",
        "org.gradle.language.cpp.internal",
        "org.gradle.language.cpp.internal.tooling",
        "org.gradle.language.cpp.plugins",
        "org.gradle.language.cpp.tasks.internal",
        "org.gradle.language.internal",
        "org.gradle.language.jvm.internal",
        "org.gradle.language.nativeplatform",
        "org.gradle.language.nativeplatform.internal",
        "org.gradle.language.nativeplatform.internal.incremental",
        "org.gradle.language.nativeplatform.internal.incremental.sourceparser",
        "org.gradle.language.nativeplatform.internal.registry",
        "org.gradle.language.nativeplatform.internal.toolchains",
        "org.gradle.language.nativeplatform.tasks",
        "org.gradle.language.objectivec.internal",
        "org.gradle.language.objectivec.plugins",
        "org.gradle.language.objectivecpp.internal",
        "org.gradle.language.objectivecpp.plugins",
        "org.gradle.language.plugins",
        "org.gradle.language.rc.internal",
        "org.gradle.language.rc.plugins",
        "org.gradle.language.rc.plugins.internal",
        "org.gradle.language.rc.tasks",
        "org.gradle.language.swift.internal",
        "org.gradle.language.swift.plugins",
        "org.gradle.language.swift.tasks.internal",
        "org.gradle.launcher.cli.converter",
        "org.gradle.launcher.configuration",
        "org.gradle.launcher.daemon",
        "org.gradle.launcher.daemon.bootstrap",
        "org.gradle.launcher.daemon.client",
        "org.gradle.launcher.daemon.configuration",
        "org.gradle.launcher.daemon.context",
        "org.gradle.launcher.daemon.diagnostics",
        "org.gradle.launcher.daemon.logging",
        "org.gradle.launcher.daemon.protocol",
        "org.gradle.launcher.daemon.registry",
        "org.gradle.launcher.daemon.server",
        "org.gradle.launcher.daemon.server.api",
        "org.gradle.launcher.daemon.server.exec",
        "org.gradle.launcher.daemon.server.expiry",
        "org.gradle.launcher.daemon.server.health",
        "org.gradle.launcher.daemon.server.health.gc",
        "org.gradle.launcher.daemon.server.scaninfo",
        "org.gradle.launcher.daemon.server.stats",
        "org.gradle.launcher.exec",
        "org.gradle.listener",
        "org.gradle.model",
        "org.gradle.model.collection.internal",
        "org.gradle.model.dsl.internal",
        "org.gradle.model.dsl.internal.inputs",
        "org.gradle.model.dsl.internal.transform",
        "org.gradle.model.internal.asm",
        "org.gradle.model.internal.core",
        "org.gradle.model.internal.core.rule.describe",
        "org.gradle.model.internal.inspect",
        "org.gradle.model.internal.manage.binding",
        "org.gradle.model.internal.manage.instance",
        "org.gradle.model.internal.manage.projection",
        "org.gradle.model.internal.manage.schema",
        "org.gradle.model.internal.manage.schema.cache",
        "org.gradle.model.internal.manage.schema.extract",
        "org.gradle.model.internal.method",
        "org.gradle.model.internal.registry",
        "org.gradle.model.internal.report",
        "org.gradle.model.internal.report.unbound",
        "org.gradle.model.internal.type",
        "org.gradle.model.internal.typeregistration",
        "org.gradle.nativeplatform.internal",
        "org.gradle.nativeplatform.internal.configure",
        "org.gradle.nativeplatform.internal.modulemap",
        "org.gradle.nativeplatform.internal.pch",
        "org.gradle.nativeplatform.internal.prebuilt",
        "org.gradle.nativeplatform.internal.resolve",
        "org.gradle.nativeplatform.internal.services",
        "org.gradle.nativeplatform.platform.internal",
        "org.gradle.nativeplatform.plugins",
        "org.gradle.nativeplatform.tasks",
        "org.gradle.nativeplatform.test.cpp.internal",
        "org.gradle.nativeplatform.test.cpp.plugins",
        "org.gradle.nativeplatform.test.cunit",
        "org.gradle.nativeplatform.test.cunit.internal",
        "org.gradle.nativeplatform.test.cunit.plugins",
        "org.gradle.nativeplatform.test.googletest",
        "org.gradle.nativeplatform.test.googletest.internal",
        "org.gradle.nativeplatform.test.googletest.plugins",
        "org.gradle.nativeplatform.test.internal",
        "org.gradle.nativeplatform.test.internal.services",
        "org.gradle.nativeplatform.test.plugins",
        "org.gradle.nativeplatform.test.xctest.internal",
        "org.gradle.nativeplatform.test.xctest.internal.execution",
        "org.gradle.nativeplatform.test.xctest.tasks",
        "org.gradle.nativeplatform.toolchain",
        "org.gradle.nativeplatform.toolchain.internal",
        "org.gradle.nativeplatform.toolchain.internal.compilespec",
        "org.gradle.nativeplatform.toolchain.internal.gcc",
        "org.gradle.nativeplatform.toolchain.internal.gcc.metadata",
        "org.gradle.nativeplatform.toolchain.internal.metadata",
        "org.gradle.nativeplatform.toolchain.internal.msvcpp",
        "org.gradle.nativeplatform.toolchain.internal.msvcpp.metadata",
        "org.gradle.nativeplatform.toolchain.internal.msvcpp.version",
        "org.gradle.nativeplatform.toolchain.internal.plugins",
        "org.gradle.nativeplatform.toolchain.internal.swift",
        "org.gradle.nativeplatform.toolchain.internal.swift.metadata",
        "org.gradle.nativeplatform.toolchain.internal.tools",
        "org.gradle.nativeplatform.toolchain.internal.xcode",
        "org.gradle.nativeplatform.toolchain.plugins",
        "org.gradle.normalization.internal",
        "org.gradle.platform",
        "org.gradle.platform.base",
        "org.gradle.platform.base.binary",
        "org.gradle.platform.base.component",
        "org.gradle.platform.base.component.internal",
        "org.gradle.platform.base.internal",
        "org.gradle.platform.base.internal.builder",
        "org.gradle.platform.base.internal.dependents",
        "org.gradle.platform.base.internal.registry",
        "org.gradle.platform.base.internal.toolchain",
        "org.gradle.platform.base.plugins",
        "org.gradle.platform.internal",
        "org.gradle.plugin.devel.plugins",
        "org.gradle.plugin.internal",
        "org.gradle.plugin.management.internal",
        "org.gradle.plugin.management.internal.autoapply",
        "org.gradle.plugin.use.resolve.internal",
        "org.gradle.plugin.use.resolve.internal.local",
        "org.gradle.plugin.use.resolve.service.internal",
        "org.gradle.plugin.use.tracker.internal",
        "org.gradle.plugins.ear",
        "org.gradle.plugins.ear.descriptor.internal",
        "org.gradle.plugins.ear.internal",
        "org.gradle.plugins.ide.api",
        "org.gradle.plugins.ide.eclipse",
        "org.gradle.plugins.ide.eclipse.internal",
        "org.gradle.plugins.ide.eclipse.model",
        "org.gradle.plugins.ide.eclipse.model.internal",
        "org.gradle.plugins.ide.idea",
        "org.gradle.plugins.ide.idea.internal",
        "org.gradle.plugins.ide.idea.model",
        "org.gradle.plugins.ide.idea.model.internal",
        "org.gradle.plugins.ide.internal",
        "org.gradle.plugins.ide.internal.configurer",
        "org.gradle.plugins.ide.internal.generator",
        "org.gradle.plugins.ide.internal.generator.generator",
        "org.gradle.plugins.ide.internal.resolver",
        "org.gradle.plugins.ide.internal.resolver.model",
        "org.gradle.plugins.ide.internal.tooling",
        "org.gradle.plugins.ide.internal.tooling.eclipse",
        "org.gradle.plugins.ide.internal.tooling.idea",
        "org.gradle.plugins.ide.internal.tooling.java",
        "org.gradle.plugins.ide.internal.tooling.model",
        "org.gradle.plugins.signing",
        "org.gradle.plugins.signing.internal",
        "org.gradle.plugins.signing.signatory.internal",
        "org.gradle.plugins.signing.signatory.internal.gnupg",
        "org.gradle.plugins.signing.signatory.internal.pgp",
        "org.gradle.problems",
        "org.gradle.problems.buildtree",
        "org.gradle.problems.internal",
        "org.gradle.process.internal",
        "org.gradle.process.internal.health.memory",
        "org.gradle.process.internal.shutdown",
        "org.gradle.process.internal.streams",
        "org.gradle.process.internal.util",
        "org.gradle.process.internal.worker",
        "org.gradle.process.internal.worker.child",
        "org.gradle.process.internal.worker.messaging",
        "org.gradle.process.internal.worker.request",
        "org.gradle.reporting",
        "org.gradle.scripts",
        "org.gradle.security.internal",
        "org.gradle.security.internal.gnupg",
        "org.gradle.security.internal.pgp",
        "org.gradle.swiftpm.internal",
        "org.gradle.swiftpm.plugins",
        "org.gradle.test.fixtures",
        "org.gradle.test.fixtures.archive",
        "org.gradle.test.fixtures.concurrent",
        "org.gradle.test.fixtures.dsl",
        "org.gradle.test.fixtures.encoding",
        "org.gradle.test.fixtures.file",
        "org.gradle.test.fixtures.language",
        "org.gradle.test.fixtures.work",
        "org.gradle.testing.base",
        "org.gradle.testing.base.internal",
        "org.gradle.testing.base.plugins",
        "org.gradle.testing.internal.util",
        "org.gradle.testing.jacoco.tasks",
        "org.gradle.testkit.runner.internal",
        "org.gradle.testkit.runner.internal.feature",
        "org.gradle.testkit.runner.internal.io",
        "org.gradle.tooling.events.configuration.internal",
        "org.gradle.tooling.events.download.internal",
        "org.gradle.tooling.events.internal",
        "org.gradle.tooling.events.lifecycle.internal",
        "org.gradle.tooling.events.task.internal",
        "org.gradle.tooling.events.task.internal.java",
        "org.gradle.tooling.events.test.internal",
        "org.gradle.tooling.events.transform.internal",
        "org.gradle.tooling.events.work.internal",
        "org.gradle.tooling.internal.adapter",
        "org.gradle.tooling.internal.build",
        "org.gradle.tooling.internal.consumer",
        "org.gradle.tooling.internal.consumer.async",
        "org.gradle.tooling.internal.consumer.connection",
        "org.gradle.tooling.internal.consumer.converters",
        "org.gradle.tooling.internal.consumer.loader",
        "org.gradle.tooling.internal.consumer.parameters",
        "org.gradle.tooling.internal.consumer.versioning",
        "org.gradle.tooling.internal.gradle",
        "org.gradle.tooling.internal.protocol",
        "org.gradle.tooling.internal.protocol.cpp",
        "org.gradle.tooling.internal.protocol.events",
        "org.gradle.tooling.internal.protocol.exceptions",
        "org.gradle.tooling.internal.protocol.test",
        "org.gradle.tooling.internal.provider",
        "org.gradle.tooling.internal.provider.action",
        "org.gradle.tooling.internal.provider.connection",
        "org.gradle.tooling.internal.provider.runner",
        "org.gradle.tooling.internal.provider.serialization",
        "org.gradle.tooling.internal.provider.test",
        "org.gradle.tooling.model.internal",
        "org.gradle.tooling.provider.model.internal",
        "org.gradle.util",
        "org.gradle.util.internal",
        "org.gradle.vcs.git.internal",
        "org.gradle.vcs.internal",
        "org.gradle.vcs.internal.resolver",
        "org.gradle.vcs.internal.services",
        "org.gradle.vcs.internal.spec",
        "org.gradle.workers.internal",
        "org.gradle.wrapper"
    ));

    private static final DescribedPredicate<JavaClass> pending_annotation =
        DescribedPredicate.describe("pending annotation with @NonNullApi", clazz -> PENDING_ANNOTATION.contains(clazz.getPackageName()));

    /**
     * This test validates that all internal classes are annotated with {@link NonNullApi}.
     * <p>
     * The annotation can be applied on the class directly, but the preferred way is to annotate the package by adding or updating the {@code package-info.java} file.
     * See {@code subprojects/core-api/src/main/java/org/gradle/package-info.java} for an example.
     * <p>
     * Note that adding the annotation for a package in one subproject will automatically apply it for the same package in all other subprojects.
     * Therefore, it's advised to add the annotation to the package in the most appropriate subproject.
     * For instance, if the package exists in both {@code :core} and {@code :base-services}, it should be annotated in {@code :base-services}.
     */
    @ArchTest
    public static final ArchRule internal_classes_are_annotated_with_non_null_api =
        classes()
            .that(gradleInternalApi()).and(classes_not_written_in_kotlin).and(not(pending_annotation))
            .should(beAnnotatedOrInPackageAnnotatedWith(NonNullApi.class));

}
